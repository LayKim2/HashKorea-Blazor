@rendermode InteractiveServer

@page "/tour-map"
@using System.Text.Json

@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<div>
    <button id="locate-btn" class="btn btn-primary mb-3">Show My Location</button>
    <div id="map" style="height: 100vh; width: 100%;"></div>
</div>

@code {
    // Location data to display on the map
    private List<Location> locations = new List<Location>
    {
        new Location { Title = "Seoul City Hall", Lat = 37.5665, Lng = 126.9780, Address = "Seoul City Hall, 110 Sejong-daero, Jung-gu, Seoul, South Korea" },
        new Location { Title = "Gangnam District, Seoul", Lat = 37.5172, Lng = 127.0473, Address = "Gangnam District, 1357-1 Gangnam-daero, Gangnam-gu, Seoul, South Korea" },
        new Location { Title = "Haeundae Beach, Busan", Lat = 35.1586, Lng = 129.1603, Address = "Haeundae Beach, 141 Haeundaehaebyeon-ro, Haeundae-gu, Busan, South Korea" }
    };

    private IJSObjectReference? _googleMapsModule;

    // OnAfterRenderAsync method to load Google Maps script and initialize map
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var apiKey = Configuration["GOOGLE_MAPS_API_KEY"];

            var locationsJson = JsonSerializer.Serialize(locations);

            await JSRuntime.InvokeVoidAsync("loadGoogleMapsScript", apiKey, "initMap", locationsJson);
        }
    }

    // This method will be called once the map script is loaded
    [JSInvokable]
    public async Task InitializeMap()
    {
        // Convert the C# location list to a JavaScript-friendly object
        var locationsJs = locations.Select(l => new
        {
            l.Title,
            l.Lat,
            l.Lng
        }).ToList();

        // Call JavaScript to initialize the map and add markers for each location
        await JSRuntime.InvokeVoidAsync("initializeMapWithMarkers", locationsJs);
    }

    // Location class to store title, latitude, and longitude
    public class Location
    {
        public string Title { get; set; }
        public double Lat { get; set; }
        public double Lng { get; set; }
        public string Address { get; set; }
    }
}
